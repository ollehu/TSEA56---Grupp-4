\documentclass[11pt]{article}

\usepackage{extras} % Se extras.sty



\begin{document}
\begin{titlepage}
\begin{center}

{\Large\bfseries TSEA56 - Kandidatprojekt i elektronik \\ LIPS Designspecifikation}

\vspace{5em}

Version 0.1

\vspace{5em}
Grupp 4 \\
\begin{tabular}{rl}
Hynén Ulfsjöö, Olle&\verb+ollul666+
\\
Wasteson, Emil&\verb+emiwa068+
\\
Tronje, Elena&\verb+eletr654+
\\
Gustafsson, Lovisa&\verb+lovgu777+
\\
Inge, Zimon&\verb+zimin415+
\\
Strömberg, Isak&\verb+isast763+
\\
\end{tabular}

\vspace{5em}
\today

\vspace{16em}
Status
\begin{longtable}{|l|l|l|} \hline

Granskad & - & - \\ \hline
Godkänd & - & - \\ \hline
 
\end{longtable}

\end{center}
\end{titlepage}

\pagebreak
\begin{center}

\section*{PROJEKTIDENTITET}
2016/VT, Undsättningsrobot Gr. 4

Linköpings tekniska högskola, ISY
\vspace{5em}
%\begin{center}

\begin{tabular}{|l|l|l|l|} \hline
\textbf{Namn} & \textbf{Ansvar} & \textbf{Telefon} & \textbf{E-post}  \\ \hline 
Isak Strömberg (IS) & Projektledare & 073-980 38 50 & isast763@student.liu.se \\ \hline
Olle Hynén Ulfsjöö (OHU)& Dokumentansvarig & 070-072 91 84 & ollul666@student.liu.se \\ \hline
Emil Wasteson (EW) & Hårdvaruansvarig & 076-836 61 66 & emiwa068@student.liu.se \\ \hline
Elena Tronje (ET) & Mjukvaruansvarig & 072-276 92 93 & eletr654@student.liu.se \\ \hline
Zimon Inge (ZI)& Testansvarig & 070-171 35 18 & zimin415@student.liu.se \\ \hline
Lovisa Gustafsson (LG) & Leveransansvarig & 070-210 32 53 & lovgu777@student.liu.se \\ \hline
\end{tabular}

%\end{center}

E-postlista för hela gruppen: isast763@student.liu.se

\vspace{5em}
Kund: ISY, Linköpings universitet 
tel: 013-28 10 00, fax: 013-13 92 82 \\
Kontaktperson hos kund: Mattias Krysander \\
tel: 013-28 21 98, e-post: matkr@isy.liu.se \\

\vspace{5em}
Kursansvarig:  Tomas Svensson\\
tel: 013-28 13 68, e-post: tomass@isy.liu.se \\
Handledare: Peter Johansson \\
tel: 013-28 13 45, e-post: peter.a.johansson@liu.se
\end{center}
\pagebreak

\tableofcontents

\pagebreak

\section*{Dokumenthistorik}
\begin{table}[h]
\begin{tabular}{|l|l|l|l|l|} \hline

\textbf{Version} & \textbf{Datum} & \textbf{Utförda förändringar} & \textbf{Utförda av} & \textbf{Granskad} \\ \hline
0.1 & - &  Första utkastet & Grupp 4 & - \\ \hline
\end{tabular}
\end{table}

\pagebreak
\pagenumbering{arabic}

\begin{flushleft}
\section{Inledning}
\lipsum

\subsection{Det totala systemet}
\lipsum


\subsection{Sensorer}
Roboten kommer vara utrustad med sex olika sensorer. Fyra infraröda sensorer av typen \verb+GP2D120+ används för att bestämma avstånden till väggarna på robotens sidor och robotens vinkel i förhållande till dessa, värden som anväds vid reglering av robotens rörelse rakt fram. Vidare finns ett kombinerat 3-axligt gyro och 3-axlig accelerometer av typen \verb+MPU-6500+ som används för att reglera rotation av roboten. Slutligen finns en lasersensor av typen \verb+Lidar-Lite v2+ för att bestämma avtåndet till väggar framför roboten. Placeringen av sensorerna visas nedan i figur \ref{sensor}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/sensor}}
	\caption{Placering av sensorer \label{sensor}}	
\end{figure}

\subsection{Ställdon}
Roboten kommer använda sig av totalt sex olika ställdon. Fyra av dessa är motorerna som driver varsitt hjul. Motorerna kan dock inte styras individuellt utan enbart parvis, varför de egentligen kan ses som två enheter. Utöver dessa ska roboten ha ett servo i gripklon, för att kunna öppna och stänga densamma, och ett servo för rotation av lasersensorn.
\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/motors}}
	\caption{Placering av ställdon \label{ställdon}}	
\end{figure}

\pagebreak
\section{Delmodul 1 - Huvudmodul}
Robotens huvudmodul har som uppgift att kommunicera med dels en extern datormodul, dels robotens övriga moduler. Kommunikationen med de övriga modulerna sker genom en tvåtrådsbuss, I\textsuperscript{2}C, och huvudmodulen fungerar där som överordnad de andra processorenheterna. Kommunikationen med datormodulen sker via  Bluetooth\textsuperscript{\circledR}. Mer intermodulär kommunikation går att läsa i avsnitt ... Förutom detta ska huvudmodulen även sköta den interna kartläggningen. 

Kopplingsschema för huvudmodulen ser ut enligt figur...? Alla avbrottsingångar används: \verb+INT0+ för knapp för att ställa in körläge,\verb+ INT1+ för knapp för att sätta på och av roboten(?) och \verb+INT2+ för avbrott från sensormodulen. Som det framgår ur figuren räcker \verb+ATmega16+ för det modulen behöver, utgångarna räcker. Det finns möjlighet att koppla in ytterligare funktion då flera utgångar ej används.  

\begin{figure}[htbp]
\centering
\noindent\resizebox{\linewidth}{!}{
	\includegraphics{images/huvudmodul.eps}}
	\caption{Kopplingsschema över huvudmodul \label{kopplingsschema:huvudmodul}}	
\end{figure}

\subsection{Detaljerad beskrivning}
\subsubsection {Körläge}
Knapp för val av körläge kopplas till \verb+INT0+. Händelseförloppet vid aktiverat avbrott kan ses i flödesschemat i figur \ref{avbrott_korlage}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.6\linewidth}{!}{
	\input{images/avbrott_korlage}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid avbrott på ingång \verb+INT0+ \label{avbrott_korlage}}	
\end{figure}

\subsubsection {Strömbrytare}
Strömbrytare i form av en knapp kopplas till \verb+INT1+. Händelseförloppet vid aktiverat avbrott kan ses i flödesschemat i figur \ref{avbrott_strombrytare}. 

\begin{figure}[htbp]
\centering
\noindent\resizebox{.6\linewidth}{!}{
	\input{images/avbrott_strombrytare}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid avbrott på ingång \verb+INT1+ \label{avbrott_strombrytare}}	
\end{figure}

\subsubsection {Sensormodul} 
\verb+INT2+ är kopplad till sensormodulen för att kunna hantera avbrott från denna. Händelseförloppet vid aktiverat avbrott kan ses i flödesschemat i \ref{avbrott_sensormodul}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{1\linewidth}{!}{
	\input{images/avbrott_sensormodul}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid avbrott på ingång \verb+INT2+ \label{avbrott_sensormodul}}	
\end{figure}

\subsubsection{Kartläggning}
Eftersom kartan enligt appendix 	C består av moduler på 40x40cm, räcker det att uppdatera kartläggningen en gång per sådan modul. Genom mätvärden från lasersensor, då den riktas framåt, kan avståndet till den främre väggen beräknas. Denna signal samplas ofta nog så att roboten kan beräkna när den har färdats till nästa modul. 

IR-sensorerna på robotens sida kan agera i avståndsområdet 5-30 cm och bottnas med andra ord när en sväng eller korsning upptäcks. Utifrån denna information kopplar kartläggningen ihop föregående modul med den typ av korsning som roboten står i. 

Kartläggningsalgoritmen är av väggföljartyp. Eftersom banan är uppbyggd så att varken höger- eller vänsterföljning prioriteras, se appendix C, så faller valet på högerföljning. Med andra ord följer roboten höger vägg och försöker först att svänga höger, därefter köra rakt fram och svänger vänster allra sist. Eftersom roboten endast ska finna den kortaste vägen från ingången till nödställde behöver nödvändigtvis inte hela kartan utforskas. Exempelvis, ifall fågelvägen från roboten till ingången är längre än en redan utforskad rutt ska roboten inte fortsätta utforska den korridoren.

Mjukvarumässigt representeras kartan med hjälp av noder och bågar, se figur \ref{labToGraph} för ett exempel av labyrintkonvertering. En ny nod bildas vid varje korsning eller där roboten tvingas svänga. Bågkostnaden utgör det relativa avståndet mellan de två kopplade noderna där det relativa avståndet mellan två moduler är en enhet.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.6\linewidth}{!}{
	\input{images/network}}
	\caption{En labyrint och dess motsvarande nätverk. Bågkostnaderna är det relativa avståndet och den optimala vägen är markerad grön.\label{labToGraph}}	
\end{figure}

När kartan är representerad som ett nätverk och roboten med säkerhet har utforskat den kortaste vägen mellan ingång och nödställd, påbörjas optimeringen. Optimeringen för att hitta den kortaste vägen sker med hjälp av optimerande metoder för att lösa minkostnadsnätverk.

Roboten tillämpar optimeringsmodellen A* vilken är en vidareutveckling av Dijkstras algoritm. A* är en bäst-först algoritm med målet att finna den billigaste vägen mellan två noder. I grund och botten finns samma maskineri som i Dijkstras algoritm fast där noder avsöks i stigande ordning av
\begin{equation*}
	f(n) = g(n) + h(n)
\end{equation*}
där $g(n)$ utgör kostnaden av rutten från startnod till nod $n$ och $h(n)$ en heuristik som estimerar den billigaste vägen från nod $n$ till slutnod. Med andra ord är Dijkstras algoritm ett speciallfall av A* där $h(n) = 0$. Heuristiken som används är det så kallade \emph{Manhattan}-avståndet eftersom labyrintens korsningar är ortogonala.

Låt $V$ vara mängden av samtliga noder, $S$ mängden av avsökta noder och $Q$ mängden av oavsökta noder. Då implementeras algoritmens utifrån pseudokoden i algoritm \ref{astar}.

\begin{algorithm}[H]
	\caption{A*} \label{astar}
	\begin{algorithmic}[1]
		\Function{AStarAlgorithm}{Graph, s}	
			\State $g(s) \gets 0$
			\State $f(s) \gets g(s) + h(s)$
			\ForAll {$v\in V - \{ s\}$}
				\State $g(v) \gets \infty$
				\State $f(v) \gets \infty$
			\EndFor
			
			\State $S \gets \emptyset$
			\State $Q \gets V$
			
			\While {$Q \neq \emptyset$}
				\State $u \gets \textrm{minFvalue}(Q,f)$%
				\Comment{Välj nod med lägst $f(n)$}
				\State $S \gets S +  \{ u\}$
				\State $Q \gets Q - \{ u\}$
				\ForAll {$v \in \textrm{neighbours}(u)$}
				\Comment{Itererare över grannar till $u$}
					\If {$g(u) + w(u,v) < g(v)$}
						\State $g(v) \gets g(u) + w(u,v)$
						\State $f(v) \gets g(v) + h(v)$
					\EndIf
				\EndFor
			\EndWhile
			
			\Return $g$
		\EndFunction
	\end{algorithmic}
\end{algorithm}
  

\subsection{Hårdvara}
Huvudmodulen kommer kräva följande hårdvara:
\begin{itemize}
	\item ATmega16
	\item  Bluetooth\textsuperscript{\circledR} ( Firefly)
\end{itemize}


\subsection{Mjukvara}
Koden i huvudmodulen är skriven i C. 

\pagebreak
\section{Delmodul 2 - Sensormodul}
Sensormodulens uppdrag är att kommunicera med både sensorerna och huvudmodulen. Mätdata samplas med konstant frekvens och konverteras därefter till motsvarande SI-enhet. För avståndssensorerna innebär detta att den analoga inspänningen konverteras till ett digitalt värde i enheten meter.

Den främre avståndssensorn (laser-sensorn) placeras på ett roterande servo så att den kan \emph{scanna} korridoren roboten befinner sig i. Detta förutsätter att servot går att styra så att vinkelutslaget går att beräkna med godtycklig precision. Tillåter inte servot en sådan styrning placeras laser-sensorn så att den konstant pekar rakt framåt.

Vinkelhastighets-sensorerna används för att beräkna vinkelutslag då roboten tar en sväng. Mätdatan behöver därför integreras under ett tidsintervall och konverteras till en vinkel. Hur den nödställde ska representeras är ännu inte fastställt. Förslagsvis används en IR-fyr i kombination med en IR-sensor. Sensormodulens uppdrag blir då att ta beslutet om när den nödställde är funnen.

\begin{figure}[htbp]
\centering
\noindent\resizebox{\linewidth}{!}{
	\includegraphics{images/sensormodul.eps}}
	\caption{Kopplingsschema över sensormodul \label{kopplingsschema:sensormodul}}	
\end{figure}
 
\subsection{Hårdvara}
Den hårdvara som sensormodulen kommer att kräva är:

\begin{itemize}
\item{Processorenhet, ATmega16 x 1}
\item{IR-sensor, GP2D120 x 2}
\item{Laser-sensor, LIDAR-Lite v2 x1}
\item{Gyro/accelerometer, MPU-6500 x 1}
\item{IR-detektor, IRM-8601-S x 1}

\end{itemize}

\subsection{Detaljerad beskrivning}

Sensormodulens processorenhet, ATmega16, är ansluten med två I\textsuperscript{2}C-bussar. Den ena är i syfte att kunna kommunicera med huvudmodulen, där sensormodulens processorenheter agerar som slavenhet i förhållande till huvudmodulens dito. Den andra I\textsuperscript{2}C-bussen kommunicerar med Lasersensorn, LIDAR-Lite v2, samt gyro/accelerometern, MPU-6500. I fallet med den senare databussen så agerar sensormodulens processorenhet som masterenhet i förhållandet med lasersensorn och gyro/accelerometern.
Resterande IR-sensor, GP2D120, och IR-detektor, IRM-8601-S, anslutes direkt till processorenhetens ingångar för AD-omvändling. Figur [??] visar en övergripande bild över sensormodulens implentation med dess respektive delkomponenter. 

\subsubsection{Processorenhet, ATmega16}
Insamlat sensordata bearbetas i modulens processorenhet för att därefter kommuniceras till huvudmodulen. Figur \ref{kopplingsschema:sensormodul} illustrerar ATmega16 och dess ingångar, samt hur respektive sensorenhet ska kopplas samman med processorn. 

\subsubsection{Laser-sensor, LIDAR-Lite v2}
Lidar-Lite v2 är en kraftfull lasersensor av begränsad storlek med ett flertal funktioner ändamålsenliga för exempelvis en undsätnningsrobot. Utöver att kunna möta avstånd, så kan den dessutom mäta hastighet och signalstyrka hos mål på upptill 40 meters avstånd. Detta med en felmarginal på 0,025 meter. Andra fördelar hos sensorn inkluderar låg strömkonsumtion och en upplösning 0,01 meter \cite{7131685}.

Kommunikationen mellan Lidar-Lite v2 och processorenheten, Atmega16, kommer att ske via ett I\textsuperscript{2}C-interface som lasersensorn kommer med i sitt grundutförande. Figur [??] konkretiserar hur implentationen av datanbussen ska genomföras. 

\subsubsection{IR-sensor, GP2D120}
För att kunna reglera på ett önskat sätt behöver roboten veta hur den förhåller sig i förhållande till sidoväggarna. Eftersom roboten ska kunna köra i mitten av korridorer med ca 40 centimeters bredd, och roboten själv är ca 20 cm bred, kommer ett avstånd mellan sidoväggarna och roboten på 10 cm vara önskvärt. För detta är IR-sensorn GP2D120 bra, eftersom den kan mäta avstånd till objekt som befinner sig på 4-30 cm ifrån sensorn. 

Mätningen av avstånd sker genom att IR-ljus med en viss våglängd skickas ut från sensorn, reflekteras mot väggarna för att till sedan sensorns detektorer känner av det reflekterade ljuset. Genom att mäta den vinkel reflektionen sker med kan avståndet till väggen bedömas.
%Om robotens reglering inte är tillräckligt bra är det risk att avståndssensorn tappar precision, %eller till och med mister avståndsbedömning helt. Det beror på att om roboten inte kör %parallellt med väggen kommer det utstrålade ljuset att reflekteras med en för stor vinkel för %att detektorerna ska kunna uppfatta reflektionen.
Figur [??] visar vilka och till vad sensorns pinnar används.


\subsubsection{Gyro/accelerometer, MPU-6500}
%\item[Vinkelhastighet] \hfill \\
I den labyrint där roboten ska hitta den nödställde kommer det finnas korsningar, vilket ställer krav på roboten att svänga. För att klara av detta används MPU6050, som får roboten att rotera. Genom att mäta hur mycket roboten roterar kan den avgöra när en 90-graderssväng är genomförd och det är dags att sluta rotera. Hastigheten på rotationen kan ställas in efter önskat behov och informationen från sensorn kommer att förmedlas via ett I\textsuperscript2C-buss-interface.
 
\subsubsection{IR-detektor, IRM-8601-S}
IR-detekron IRM-8601-S används i syfte att indentifiera den nödställde, vilken ska sända ut en IR-signal. Liksom Figur [??] illustrerar så är IRM-8601-s förhållandevis trivial i sitt utförande, enheten har 2 ingångar vilka ska anslutas med 5 V samt jord. 

\item[Identifierare av nödställd] \hfill \\


\subsection{Mjukvara}
Sensormodulens kod är skriven i C och har som huvuduppgift att göra om de analoga signaler som uppmäts till digitala signaler som skickas visare till huvudmodulen. De olika sensorerna tar in olika typer av analoga signaler, vilket innebär att även fler typer av omvanlingar behöver vara möjliga. Alla omvandlingar sker i enhetens processorenhet, ATmega16.

\subsubsection{IR-sensorerna}
GP2120 och IRM-8601-S reflekterar ljus för att identifiera nödställd och mäta avstånd och vinklar mot omgivande objekt. Utsignalen vid dessa operationer är spänning (Vout), vilket behöver göras om till ett digitalt värde för att kunna skicka vidare informationen. Omvandlingen sker via ekvationXYXY, där den maximala utsignalen är 5 volt. Det analoga värdet delas upp i 256 digitala värden som motsvarar olika spänningar. 

\subsubsection{LIDAR-Lite}
text

\pagebreak
\section{Delmodul 3 - Styrmodul}
Styrmodulens uppgift är att översätta styrkommandon till servostyrning av de fyra hjulen och gripklon. Styrkommandona kommer via en I\textsuperscript{2}C-bussen från huvudmodulen och konverteras därefter till en PWM-sekvens. PWM-sekvensen skickas till gripklon respektive H-bryggorna som styr ett hjulpar var. 

Kopplingsschemat ser ut enligt figur \ref{kopplingsschema:styrmodul}, det framgår från figuren att utgångarna från \verb+ATmega16+ räcker för modulens ändamål. Både avbrottsingång \verb+INT0+ och \verb+INT1+ används inte men reservas ifall ytterligare funktionalitet önskas lägga till. Det finns även möjlighet att att styra en extra komponent via PWM eftersom utgången \verb+OC2+ är oanvänd.  

Prestandan hos \verb+ATmega+ räcker för modulens syfte. 

\begin{figure}[htbp]
\centering
\noindent\resizebox{\linewidth}{!}{
	\includegraphics{images/styrmodul.eps}}
	\caption{Kopplingsschema över styrmodul \label{kopplingsschema:styrmodul}}	
\end{figure}
 
\subsection{Detaljerad beskrivning}
Nedan följer en beskrivning av vilka styrkommandon styrmodulen ska kunna ta emot, hur kommunikationsprotokollet ser ut, hur regleringen ska ske samt lite övrig fakta kring modulen.

\subsubsection{Styrkommandon}\label{Styrkommandon}
Styrmodulen tar emot kommandon från huvudmodulen och verkställer dessa. Följande kommandon kommer kunna skickas: \textit{reglering av/på, gripklo öppna/stäng, fram/bak, sväng höger/vänster, rotera höger/vänster och stopp}. Kommandot \textit{reglering av/på} ställer in styrmodulen för manuell eller autonom körning, vilket påverkar tolkningen av det data som skickas från huvudmodulen.

Tillsammans med kommandona för rörelse skickas även ett tal som, beroende på om reglering är aktiverad eller inte, anger en sträcka/vinkel för förflyttningen eller med vilken hastighet (i procent av maxhastighet) förflyttningen ska utföras. Ett kommando kan exempelvis se ut såhär: \textit{fram 80}, varpå roboten antingen kör framåt 80 cm eller med 80\% av maxhastighet, beroende på om regleringen är aktiverad eller inte. Modulen kommer vara designad så att ett körkommando gäller tills dess att ett nytt kommando skickas, varför även kommandot för \textit{stopp} är nödvändigt.

Eftersom kommandona till styrmodulen skickas på den form som visats ovan kommer all reglering behöva ske i styrmodulen. Därför kommer även mätdata att tas emot från huvudmodulen. Beroende på vilken typ av förflyttning roboten utför så kommer följande sensorvärden att skickas från huvudmodulen:
\begin{itemize}
	\item fram/bak - avstånd till vägg fram och på sidorna.
	\item sväng höger/vänster - inga (kommandot används enbart vid manuell styrning och behöver således inte regleras).
	\item rotera höger/vänster - vinkel och vinkelhastighet.
\end{itemize}
Dessa sensorvärden kommer skickas med en frekvens av \textcolor{red}{x} Hz förutsatt att reglering är aktiverad, det vill säga vid autonom styrning av roboten.

\subsubsection{Reglering}
Vid manuell styrning av roboten sker ingen reglering. Detta för att användaren ska få ohämmad kontroll över roboten och förväntas sköta ``regleringen'' manuellt. Vid autonom styrning kommer dock alla förflyttningar behöva regleras. Som nämnt i avsnitt \ref{Styrkommandon} kommer huvudmodulen skicka relevanta sensorvärden vid autonom körning. Beroende på vilket styrkommando som skickats väljer styrmodulen sedan en styrmod och reglerar rörelsen. De olika styrmodulerna och hur deras reglering sker finns beskrivet mer ingående i Appendix \textcolor{red}{x}.

\subsubsection{Övrigt}
Plattformen som roboten byggs på har färdiga kretsar för att styra chassits hjul. Hjulen kan styras parvis (höger och vänster) genom att sätta en bit för att bestämma rotationsriktningen och sedan skicka en PWM-signal för att bestämma rotationshastigheten. Roboten styrs alltså differentiellt, dvs genom olika hastighet på höger och vänster sida.

Roboten ska även vara utrustad med en gripklo, för att kunna greppa de förnödenheter som ska transporteras. Klons aktiva del består av ett servo av typen \verb+RG-180+ som styrs med en PWM-signal.

Det ska även finnas en alphanumerisk LCD-display, av typen \verb+LCD JM162A+, på roboten, som används för att visa relevanta sensorvärden vid reglering. Den har totalt 16 pinnar, varav åtta är databitar, tre används för konfiguration och resterane är referensignaler och strömtillförsel.

\subsection{Hårdvara}
Styrmodulen kommer kräva följande hårdvara:
\begin{itemize}
	\item ATmega16
	\item Robotplattform (Terminator)
	\item Gripklo %Specificera senare
\end{itemize}

\subsection{Mjukvara}
Koden för styrmodulen är skriven i C och består främst av två delar, reglering och display. Gripklon styrs direkt av ett styrkommando och kan endast öppnas respektive stängas.

\subsubsection{Display}
Displayen är en alphanumerisk 16x2 LCD-display och ska visa utvalda sensorvärden i realtid. I koden används drivrutinen \emph{lcd.h} för att initiera och skriva text till displayen. Genom att anropa initieringsmetoden rensas displayen och pekaren placeras på rätt position. Därefter skrivs typen av mätvärde och det faktiska värdet ut. Tack vare två rader kan flera mätvärden skrivas ut samtidigt, förslagsvis ett i respektive hörn av displayen.

Utskriften till displayen sker i huvudloopen och i takt med att nya mätvärden tas emot.

\subsubsection{Reglering}
När styrmodulen tar emot ett kommando från huvudmodulen så regleras servona utifrån de senaste mottagna sensorvärdena. Den reglering som programmeras till modulen består av tre komponenter. Den ena ser till att roboten färdas i mitten av korridoren, den andra anpassar hastigheten utifrån korridorens längd och den tredje ser till att en sväng tas vinkelrätt.

Isak: fortsätt på stycket och förklara regleringen utifrån din förstudie

\pagebreak
\section{Delmodul 4 - Datormodul}
Datormodulens syfte är att presentera ett gränssnitt för att styra, kartlägga och felsöka roboten i realtid. Kommunikationen sker via Bluetooth\textsuperscript{\circledR} och består av styrkommandon (datormodul $\rightarrow$ huvudmodul) samt mätvärden och karta (huvudmodul $\rightarrow$ datormodul). 

\subsection{Detaljerad beskrivning}
Mjukvarans grafiska gränssnitt konstrueras enligt figur \ref{datormodul:software}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.5\linewidth}{!}{
	\input{images/software}}
	\caption{Datormodulens GUI \label{datormodul:software}}	
\end{figure}

Kartan över labyrinten ritas successivt upp under robotens färd och presenteras ur ett fågelperspektiv. I första hand ritas kartan i två dimensioner och i mån av tid utvecklas en tredimensionell karta där roboten följs ur ett tredjepersons-perspektiv. 

Tabellen över sensordata skriver ut informationen den senaste kommunikationen med huvudmodulen. Kommunikationen består av sensorvärden som huvudmodulen har tagit del av från sensormodulen. Eftersom sensormodulen konverterar de analoga sensor-spänningarna till SI-enheter presenterar tabell-rutan avstånd och vinklar istället för de faktiska spänningsnivåerna. 

Grafen över historiska sensordata tar del av samma information som tabellen, men ritar även ut tidigare data i form av en graf. Denna ruta används främst för felsökning och ger ett tidsperspektiv till sensordatan.

Panelen för knappar visar vilken knappkombination från tangenbordet som är aktiv. Tabell \ref{datormodul:combinations} visar möjliga knappkombinationer och dess översättning till styrkommando. Panelen fyller i de knappar som hålls nere och varnar ifall en knappkombination är otillåten, exempelvis ifall \mbox{$\leftarrow$ och $\rightarrow$} trycks samtidigt.

\begin{longtable}{|p{.05\linewidth} p{.05\linewidth} p{.05\linewidth} p{.05\linewidth} c l|}
	\multicolumn{4}{c}{\textbf{Knapptryckning}} & & \multicolumn{1}{l}{\textbf{Översättning}} 	\\ \nobreakhline\nobreakhline 
	$\uparrow$ &  				&  				& 				& = & Kör framåt 				\\ \nobreakhline 
	$\uparrow$ & $\leftarrow$	&				&				& = & Kör framåt vänster 		\\ \nobreakhline 
	$\uparrow$ &				& $\rightarrow$	&				& = & Kör framåt höger 			\\ \nobreakhline 
			   & $\leftarrow$	&				&				& = & Rotera medurs 			\\ \nobreakhline
			   &				& $\rightarrow$	&				& = & Rotera moturs 			\\ \nobreakhline
			   & $\leftarrow$	&				& $\downarrow$	& = & Kör bakåt vänster 		\\ \nobreakhline
			   &				& $\rightarrow$ & $\downarrow$	& = & Kör bakåt höger 			\\ \nobreakhline
			   &				&				& $\downarrow$	& = & Kör bakåt 				\\ \nobreakhline
	\caption{Knapptryckningar och dess översättning} \label{datormodul:combinations}
\end{longtable}



\subsection{Hårdvara}
Datormodulen kräver en dator kompatibel med Java och Bluetooth\textsuperscript{\circledR}. 

\subsection{Mjukvara}
Gränssnittet programmeras i Java SE 7 och körs i Java Runtime Environment. Valet av programmeringsspråk faller på Java eftersom samma mjukvara ska köras på Windows, OSX och Linux. Kommunikationen via Bluetooth\textsuperscript{\circledR} sker med hjälp av ett existerande Bluetooth\textsuperscript{\circledR}-API utvecklat av Oracle för Java. 

Swing och AWT används för att ge användaren ett grafiskt gränssnitt. Själva huvudklassen är centrerad kring Bluetooth\textsuperscript{\circledR}-kommunikationen och loopar i takt med att en ny sändning har skickats eller mottagits. 

\pagebreak
\section{Intermodulär kommunikation}
För kommunikation mellan de olika modulerna kommer en I\textsuperscript{2}C-buss och Bluetooth\textsuperscript{\circledR} användas. 

\subsection{I\textsuperscript{2}C-buss}
För att kommunicera mellan de olika modulerna kommer den två trådade I\textsuperscript{2}C-bussen att användas. Då modulerna i huvudsak kommer bestå av processorn ATMega16 kommer allt vara kopplat till samma buss. Detta för att ATMega16 enbart har en upsättning av de ingångar som krävs, SCL och SDA. Eftersom mycket av tänkadet ligger i huvudmodulen får den master-status. Resterade blir slavar då informationen som ska mellan sensormodulen och styrmodulen även behövs i huvudmodulen.

\subsection{Bluetooth\textsuperscript{\circledR}-kommunikation}
För dataöverföring via Bluetooth\textsuperscript{\circledR} kommer FireFly-modulen användas. Robotens enhet kommer vara kopplad till huvudmodulens processor. Överföringen sker seriellt med protokoll enligt figur \ref{bluetooth}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/bluetooth}}
	\caption{Protokoll för överföring mellan huvud- och datormodul \label{bluetooth}}	
\end{figure}

Respektive segment motsvarar följande:
\begin{itemize}
	\item A - Startbit
	\item B - Informationsbitar (vanligen sju eller åtta stycken)
	\item C - Eventuell paritetsbit
	\item D - Slutbit (en eller två stycken)
\end{itemize}

För att initera kontakt används så kallade handskakningssignaler för att avgöra om vardera ände är redo att skicka respektive ta emot.

\subsection{Informationsflöde}
I figur \ref{informationFlow} visualiseras informationsflödet. Där anges mottagare och sändare samt vilken typ av information som går mellan dem.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/informationFlow}}
	\caption{Schema över informationsflödet\label{informationFlow}}	
\end{figure}

\subsubsection{Kommunikationsprotokoll - styrmodul}
Följande protokoll används för att skicka data till styrmodulen:

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/controlldata}}
	\caption{Protokoll för dataöverföring mellan huvud- och styrenhet\label{styrdata}}	
\end{figure}

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (Bit x-y) - Startbit
	\item B (Bit x-y) - Definierar om ett körkommando eller ett sensorvärde skickas.
	\item C (Bit x-y) - Definierar vilket kommando eller vilken typ av värde som skickas.
	\item D (Bit x-y) - Hastighet (om körkommando och inte reglering), sträcka/vinkel (om körkommando och reglering) eller värde (om sensorvärde).
	\item E (Bit x-y) - Slutbit
\end{itemize}

\pagebreak
\section{Implementering}
\lipsum

\pagebreak
\addcontentsline{toc}{section}{Referenser}
\bibliographystyle{ieeetr}
\bibliography{references}

\end{flushleft}

\end{document}