\documentclass[11pt]{article}

\usepackage{extras} % Se extras.sty

\begin{document}
\begin{titlepage}
\begin{center}

{\Large\bfseries TSEA56 - Kandidatprojekt i elektronik \\ LIPS Teknisk dokumentation}

\vspace{5em}

Version 1.0

\vspace{5em}
Grupp 4 \\
\begin{tabular}{rl}
Hynén Ulfsjöö, Olle&\verb+ollul666+
\\
Wasteson, Emil&\verb+emiwa068+
\\
Tronje, Elena&\verb+eletr654+
\\
Gustafsson, Lovisa&\verb+lovgu777+
\\
Inge, Zimon&\verb+zimin415+
\\
Strömberg, Isak&\verb+isast763+
\\
\end{tabular}

\vspace{5em}
\today

\vspace{16em}
Status
\begin{longtable}{|l|l|l|} \hline

Granskad & - & - \\ \hline
Godkänd & - & - \\ \hline
 
\end{longtable}

\end{center}
\end{titlepage}

\pagebreak
\begin{center}

\section*{PROJEKTIDENTITET}
2016/VT, Undsättningsrobot Gr. 4

Linköpings tekniska högskola, ISY
\vspace{5em}
%\begin{center}

\begin{tabular}{|l|l|l|l|} \hline
\textbf{Namn} & \textbf{Ansvar} & \textbf{Telefon} & \textbf{E-post}  \\ \hline 
Isak Strömberg (IS) & Projektledare & 073-980 38 50 & isast763@student.liu.se \\ \hline
Olle Hynén Ulfsjöö (OHU)& Dokumentansvarig & 070-072 91 84 & ollul666@student.liu.se \\ \hline
Emil Wasteson (EW) & Hårdvaruansvarig & 076-836 61 66 & emiwa068@student.liu.se \\ \hline
Elena Tronje (ET) & Mjukvaruansvarig & 072-276 92 93 & eletr654@student.liu.se \\ \hline
Zimon Inge (ZI)& Testansvarig & 070-171 35 18 & zimin415@student.liu.se \\ \hline
Lovisa Gustafsson (LG) & Leveransansvarig & 070-210 32 53 & lovgu777@student.liu.se \\ \hline
\end{tabular}

%\end{center}

E-postlista för hela gruppen: isast763@student.liu.se

\vspace{5em}
Kund: ISY, Linköpings universitet 
tel: 013-28 10 00, fax: 013-13 92 82 \\
Kontaktperson hos kund: Mattias Krysander \\
tel: 013-28 21 98, e-post: matkr@isy.liu.se \\

\vspace{5em}
Kursansvarig:  Tomas Svensson\\
tel: 013-28 13 68, e-post: tomass@isy.liu.se \\
Handledare: Peter Johansson \\
tel: 013-28 13 45, e-post: peter.a.johansson@liu.se
\end{center}
\pagebreak

\tableofcontents

\pagebreak

\section*{Dokumenthistorik}
\begin{table}[h]
\begin{tabular}{|l|l|l|l|l|} \hline

\textbf{Version} & \textbf{Datum} & \textbf{Utförda förändringar} & \textbf{Utförda av} & \textbf{Granskad} \\ \hline
1.0 & - &  Första utkastet & Grupp 4 & - \\ \hline
\end{tabular}
\end{table}

\pagebreak
\pagenumbering{arabic}

\begin{flushleft}
\section{Inledning}
\textit{Bakgrund och syfte}

Projektets syfte är att konstruera en undsättningsrobot. Detta dokument syftar till att ge en detaljerad teknisk beskrivning av projektet på en nivå där resultatet ska kunna återskapas. Innehållet består av detaljerade beskrivningar av systemets olika delar, dess mjuk- och hårdvarukomponenter samt implementationen.

\section{Produkten}
\textit{En bild på produkten och en beskrivning av hur den fungerar. Beskriv vad den används till.}

Produkten som konstruerats är en undsättningsrobot. Den består av fyra hjul, ett chassi och en gripklo som ska kunna greppa en förnödenhet att leverera till en nödställd. På chassit är huvudmodulen, sensormodulen och styrmodulen ihopkopplade via en I\textsuperscript{2}C-buss medan kommunikationen med datormodulen sker via Bluetooth\textsuperscript{\circledR}, enligt figur \ref{overview}. Gripklon kontrolleras av styrmodulen medan det är sensormodulen som tar in data från sensorerna.

Varje modul har en processor samt annan nödvändig hårdvara, som lågpassfilter och brytare, kopplade på ett virkort. Virkorten kan användas som grund för att tillverka kretskort med motsvarande funktion. 

Tanken med roboten är att den ska söka av en labyrint bestående av 40 cm breda korridorer och identifiera en nödställd som sänder ut IR-ljus. Det ska den klara i både manuellt och autonomt läge. När målet är identifierat ska kortaste vägen mellan labyrintens ingång och målet bestämmas. Då ska roboten hämta en förnödenhet vid starten och köra kortaste vägen till den nödställda och lämna av förnödenheten. 


\begin{figure}[!htbp]
\centering
\noindent\resizebox{\linewidth}{!}{
	\input{images/overview}}
	\caption{Det totala systemet \label{overview}}	
\end{figure}

\pagebreak

Med hjälp av en avsökningsalgoritm kan roboten navigera i ett labyrintsystem. Denna är beroede av sensorer för att få en uppfattning om sin omgivning samt en styrenhet för att kunna röra sig i förhållande till sin omgivning. Navigationen pågår tills den detekterar en nödställd. Då ser den till att finna den kortaste vägen ut för att där hämta en förnödenhet med gripklon som den sedan åker och lämnar till den nödställde. 

\section{Teori}
\textit{Beskrivning av regleralgoritmer mm.}

\subsection{Beräkning av kortaste väg}
Nedan beskrivs två algoritmer för att få fram kortaste väg.

\subsubsection{Dijkstras algoritm}
Dijkstras algoritm är en girig, bäst-först-algoritm. Genom algoritmen beräknar man den billigaste (kortaste) vägen från startnoden till samtliga noder och den fungerar på nätverk med icke-negativa bågkostnader. 

Vid starten definieras två mängder, en mängd som innehåller de avsökta noderna och en de oavsökta noderna. De oavsökta noderna får ett oändligt nodpris och startnoden nodpriset noll. Med ursprung i startnoden sökes alla grannar genom. Nodpriset updateras i det fall då följande samband gäller:

\begin{displaymath}
	y_i + c_{i,j} < y_j
\end{displaymath}

där \begin{math} y_i \end{math} är den nod som söks av, \begin{math} c_{i,j} \end{math} kostnaden mellan nod \begin{math} i \end{math} och \begin{math} j \end{math}, och \begin{math} y_j \end{math} är nodgrannen.

Ovanstående görs successivt med ursprung i den nod med billigast nodpris tills slutnoden har undersökts. Den kortaste vägen kan sedan nästlas upp om man även sparar vilken föregångare som bidrog till en kortare väg. 

En vidareutveckling av Dijkstras algoritm är A* som, med hjälp av en heuristik, väljer vilka noder som ska avsökas vidare.

\subsubsection{A*}
A* är ytterligare en bäst-först-algoritm med målet att finna den billigaste vägen mellan två noder. I grund och botten finns samma maskineri som i Dijkstras algoritm fast där noder avsöks i stigande ordning av
\begin{equation*}
	f(n) = g(n) + h(n)
\end{equation*}
där $g(n)$ utgör kostnaden av rutten från startnod till nod $n$ och $h(n)$ en heuristik som estimerar den billigaste vägen från nod $n$ till slutnod. Med andra ord är Dijkstras algoritm ett speciallfall av A* där $h(n) = 0$.

$h(n)$ kan ses som en straffunktion som avtar nära slutnoden. A* kan alltså, till skillnad från Dijkstras algoritm, se framåt i nätverket och kan därför ta bättre beslut om vilka noder som ska uppdateras.

\subsection{Reglering}\label{subsection:reglering}
Roboten har två olika reglermoder: reglering av rotation och reglering av rak körning. Regleringen av rak körning har i sin tur fyra olika lägen, som anpassar vilken insignal som används i regleringen: inga väggar, vägg på vänster sida, vägg på höger sida och vägg på båda sidor.

Rotationen regleras genom öppen reglering. Robotens gyro ger en vinkelhastighet som sedan integreras (summeras) tills summan nått ett förutbestämt värde varefter rotationen avbryts.

Regleringen av rak körning innebär reglering av två utsignaler: robotens avstånd till framförvarande vägg och robotens avstånd till väggen eller väggarna i korridoren. Avståndet till framförvarande vägg $s$ regleras i förhållande till det önskade avståndet $s^0$ genom reglering av hastigheten $v$ enligt följande ekvation
\begin{equation*}
	v = 
	\begin{cases}
		v_{pref} \qquad\qquad \forall \ (s - s^0) > 20 \\
		0.6 \cdot v_{pref} \qquad \forall \ 20 \geq (s - s^0) > 0 \\
		0 \qquad\qquad\qquad \forall \ (s - s^0)\leq 0 \\
	\end{cases}
\end{equation*}
där $v_{pref}$ är den användardefinierade maxhastigheten.

Avståndet till väggen regleras genom att beräkna önskad skillnad i hastighet mellan höger och vänster hjulpar $\Delta v$ utifrån främre avståndssensor $d_1$, bakre avståndssensorn $d_2$ och det önskade avståndet $d^0$ enligt följande ekvation
\begin{equation*}
	\Delta v = K \Bigg( P \Big( \frac {d_1 + d_2} {2} - d^0 \Big) + D (d_1 - d_2) \Bigg)
\end{equation*}
där $K, P, D > 0$ är konstanter som används för att justera regleringen. Beroende på vilka väggar som finns inom sensorernas räckvidd används antingen vänster eller höger avståndssensorer som insignal. Vid vänster vägg eller dubbla väggar används vänster eller vid höger vägg används höger. Vid dubbla väggar anväds dock sensorerna på båda sidor för att bestämma  $d^0$ enligt
\begin{equation*}
	d^0 = \frac {d_{1,v} + d_{2,v} + d_{1,h} + d_{2,h}} {4}
\end{equation*}

Känner avståndssensorerna inte av väggar på någon sida kan inte avståndet till väggarna regleras och $\Delta v = 0$.

\section{Systemet}
\textit{Ett översiktligt blockschema och en beskrivning av hela systemet.}

Roboten i sin miljö finns illustrerad i figur \ref{system}. Kommunikationen med datormodulen är dubbelriktad och via Bluetooth\textsuperscript{\circledR}. Roboten ska dock även klara sitt uppdrag utan kommunikation med datormodulen. Det vill säga att kartläggning, styrning och optimering av kortaste väg sker lokalt hos roboten. Banan är uppbyggd enligt banspecifikationen och uppdraget utförs enligt tävlingsreglerna, se appendix [??].

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/bana}}
	\caption{Översikt av banan\label{system}}	
\end{figure}

\subsection{Beskrivning av systemet}
Roboten navigerar själva banan med hjälp av en lasersensor som mäter avstånd framåt, fyra IR-sensorer som mäter robotens avstånd till respiktive vägg i korridoren, ett gyroskop som mäter vinkelhastighet samt en IR-detektor för identifiering av nödställd. En regleringsmodell säkerställer att roboten färdas i mitten av korridorerna samt kan rotera både 90 och 180 grader utan att stöta mot väggar. Under färden ska roboten autonomt kartlägga och finna den kortaste vägen mellan ingången och den nödställde. I det fall då roboten även är uppkopplad mot datormodulen ska mjukvara på datorn successivt rita upp en karta och kunna presentera utvalda mätvärden i realtid. När den kortaste vägen är funnen ska roboten använda denna rutt för att förse den nödställde med en förnödenhet. Förnödenheten transporteras med hjälp av robotens gripklo.

Blockshemat för systemet återfinns i figur \ref{blockSystem}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{1\linewidth}{!}{
	\input{images/systemet}}
	\caption{Övergripande blockschema för systemet}	\label{blockSystem}
\end{figure}

\section{Begränsningar}
Roboten är begränsad till att navigera i enbart korridorer och att alla korsningar sker med 90 gradersvinklar.

\section{Modulerna}
\textit{Innehåller mera detaljerade blockschemor och beskrivningar av varje modul. Tänk på läsbarheten och växla mellan figurer och text.}
I detta avsnitt följer en detaljerad beskrivning av systemets ingående moduler. 

\subsection{Huvudmodulen}
Huvudmodulen har som uppgift att ta emot och förmedla information mellan de andra modulera, hantera den interna kartläggnigen samt att ta alla övergripande beslut. Bluetooth\textsuperscript{\circledR} används för att kommunicera med datormodulen och en avbrottsstyrd I\textsuperscript{2}C-buss används för att kommunicera med sensor- och styrmodulen, vilket visas i figur \ref{communication}. När det kommer till prioriteringen av sensor- och styrmodul har styrmodulen kopplats till en extern avbrottsingång med högre prioritet än sensormodulen.

\begin{figure}[htbp]
\noindent\resizebox{.97\textwidth}{!}{
	\input{images/communication}}
	\caption{Intermodulär kommunikation \label{communication}}
\end{figure}

Det finns två olika körlägen för roboten, ett autonomt och ett manuellt läge. Rent hårdvarumässigt styrs val av läge med hjälp av en brytare kopplad till huvudmodulen. När det autonoma läget är aktiverat tas körbeslut utifrån en avsökningsalgoritm som i grunden använder sig av högerföljning. Beslutet om vilken kartmodul som ska besökas härnäst baseras på datan som skickats från sensormodulen och på den interna kartläggningen. När beslutet är taget skickas motsvarande kommando till styrmodulen som sedan utför önskad operation. Ett nytt beslut tas när styrmodulen anser sig vara färdig med nuvarande kommando och begär ett nytt genom avbrott. Hela kommunikationsflödet i autonomt läge finns beskrivet i figur \ref{autonomousMode}. I manuellt läge skickas styrkommandon från datormodulen, via Bluetooth\textsuperscript{\circledR}, till huvudmodulen som sedan vidarebefordrar dessa till styrmodulen. Informationen som skickas baseras på vilken piltangent på datormodulen som är nedtryckt enligt flödet i figur \ref{manualMode}..

Den interna kartläggningen sker kontinuerligt allt eftersom roboten utforskar labyrinten. Den interna kartan representeras av en 28x28 array. I denna lagras varje ny modul som roboten besöker och var sensorerna har registrerat väggar. Efter varje ny besökt modul skickas de uppdaterade värden i arrayen till datormodulen för uppritning om denna är ansluten. Är så ej fallet skickas alla ny information till datormodulen när anslutning har upprättats. Återvändsgränder där mål ej hittats och andra ointressanta vägar sparas i en annan 28x28 array för att förenkla avsökningen och för att ointressanta vägar ej ska besökas igen.

Beräkningen av kortaste vägen till målet sker med utgångspunkt från Dijkstras algoritm. När målet är funnet numreras varje nod som roboten besöker från målet  med en siffra som representerar ett avstånd till målet. Kortaste väg från start till mål fås då genom att, för varje nod, välja den närliggande nod med lägst siffra. För att inte utforska mer än nödvändigt används en pessimistisk skattning av avståndet från start till mål. Det antal steg robotens första väg från start till mål blir, återvändsgränder borträknat, sätts till den pessimistiska skattningen. Under den fortsatta utforskningen av labyrinten jämförs denna skattning med summan av köravståndet från målet  och manhattanavståndet från start till aktuell nod. Är det avståndet lika med eller större än skattningen är det inte nödvändigt att utforska mer åt det hållet vilket inte heller görs.

\begin{figure}[htbp]
\centering
\noindent\resizebox{0.9\linewidth}{!}{
	\input{images/autonomousMode}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid autonom styrning \label{autonomousMode}}	
\end{figure}

\begin{figure}[htbp]
\centering
\noindent\resizebox{0.9\linewidth}{!}{
	\input{images/manualMode}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid manuell styrning \label{manualMode}}	
\end{figure}

\pagebreak

\subsection{Sensormodulen}
Robotens sensormodul har som uppgift att läsa av sensorerna och kommunicera datan till huvudmodulen. De sensorer som används är följande, NAMN PÅ SENSORER
\begin{description}
	\item[Avstånd] \hfill \\
	4 x IR-sensor \verb+GP2D120+ (4 cm till 30 cm) \\
	1 x Laser-sensor \verb+LIDAR-Lite v2+ (0 till 40 m) \\
	\item[Vinkelhastighet] \hfill \\
	1 x Gyro/accelerometer \verb+MPU-6500+ 
	\item[Identifierare av nödställd] \hfill \\
	1 x IR-detektor \verb+IRM-8601-S+
\end{description}
och är placerade enligt figur \ref{sensors}. 

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\textwidth}{!}{
	\input{images/sensor}	}
	\caption{Sensorplacering \label{sensors}}
\end{figure}

\subsection{Styrmodulen}

Styrmodulen är den del av roboten som tar emot och verkställer styrkommandon och ser till att roboten tar sig fram på önskat sätt. Det som hanteras är styrning av chassits motorer för att få roboten att röra på sig och att styra gripklon. 

De komponenter som ingår i styrmodulen är
\begin{itemize}
  \item[-] \verb+ATmega1284p+,
  \item[-] LCD-display \verb+JM162A+,
  \item[-] Kristalloscillator \verb+EXO-3+ på $16$ MHz,
  \item[-] LED-dioder, 
  \item[-] Resistanser,
  \item[-] Potentiometer och
  \item[-] Studsfri tryckknapp.
\end{itemize}

Styrmodulen kopplas enligt kretsschemat i appendix \ref{kopplingsschema:styrmodul}. Kopplingen sker på ett virkort som sedan monteras på robotens chassi. Härefter följer detaljerade beskrivningar av styrmodulens olika delar.

\subsubsection{Mjukvara}
Mjukvaran till styrmodulen består av följande filer.
\begin{description}[style=unboxed, leftmargin=0cm]
  \item[controlModule.c] som innehåller \textit{main}-funktionen, I\textsuperscript{2}C-kommunikationen och regleringen. I huvudloopen är den endast LCD-displayen och LED-dioderna som uppdateras.
  \item[PWM.h] som är ett paket för pulsbreddsmodulering.
  \item[LCD.h] som är ett paket för LCD-displayen.
  \item[constants.h] som är ett paket med definitioner av konstanter till controlModule.c.
  \item[I2C\_slave.h] som är ett paket för slavar inom I\textsuperscript{2}C-bussen.

\end{description}


\subsubsection{PWM}
Pulsbreddsmodulering används för att styra respektive hjulpar, gripklon och servot för den främre sensorn. På \verb+ATMega1284+ har varje timer två utgångar, utgång A och B. En timer kopplas således till båda hjulparen så att respektive utgång styrs med olika arbetscyklar, men delar samma inställningar gällande frekvens och periodtid. Gripklon och servot för den främre sensorn delar även samma egenskaper och tilldelas en gemensam timer. Samtliga timers som används är av 16-bitarstyp, men alla bitar behövs inte och de konfigureras därför enligt nedan. 

\begin{center}
\begin{tabular}{l l l l l}

    \textbf{Syfte} & \textbf{Läge} & \textbf{Antal bitar} & \textbf{Prescale} & \textbf{Toppvärde} \\
    Hjulpar & Fast PWM, 10-bit & 10 bitar & $\text{clk}/64$ &  0x03FF \\
	Gripklo och sensorservo & Fast PWM & 16 bitar & $\text{clk}/64$  & ICR \\
\end{tabular}
\end{center}

\subsubsection{LCD-display}
LCD-displayen, \verb+JM162A+, består av två rader där respektive har plats för 16 tecken. På displayen visas sensordata under robotens färd och uppdateras i takt med att nya sensordata anländer. En potentiometer kopplas in för att justera kontrastspänningen och LCD:n konfigureras enligt nedan.

\begin{center}
  \begin{tabular}{l l l l l l l l}
      \textbf{Modell} & \textbf{Bitar} & \textbf{Rader} & \textbf{Punkter} & \textbf{Pekare} & \textbf{Blink} & \textbf{Öka pekare} & \textbf{Skifta text} \\
      \verb+JM162A+ & 8 & 2 & 5x7 & Av & Av & På & Av \\
    \end{tabular}
  \end{center}

\subsubsection{Styrlägen}
Styrmodulen har två olika styrlägen: autonomt eller manuellt läge.
\begin{description}[style=unboxed, leftmargin=0cm]
  \item[Autonomt läge]
I autonomt läge agerar styrmodulen på beslut som tas från huvudmodulen. Målet är att navigera modulvis genom den avsökningalgoritm som huvudmodulen utövar. Styrmodulen begär ett nytt styrkommando genom att skicka en uppåtflank på en utgång som är kopplad till ett avbrott hos huvudmodulen. Huvudmodulen tar därefter ett beslut om vilket styrkommando som ska skickas. De möjliga styrkommandona är \textit{Fram}, \textit{Rotera 90\textdegree\ vänster}, \textit{Rotera 90\textdegree\ höger}, \textit{Rotera 180\textdegree} och \textit{Stopp}. 

När ett styrkommando tas emot av styrmodulen sker regleringen i samband med inkommande sensordata. För att regleringen ska agera snabbt nog behöver sensordata skickas i takten $30$ Hz. När sensordata tas emot sparas samtliga värden lokalt i styrmodulen, därefter kallas den metod som sköter reglering av styrkommandot. 

Styrkommandot \textit{Fram} innebär att roboten ska flytta sig en modul föröver. Modullängden är densamma för hela banan och satt till $40$ cm. Roboten beräknar tillryggalagd sträcka genom att beräkna antalet varv hjulen roterar och under färden sker reglering enligt avsnitt \ref{subsection:reglering}. När modulen är avverkad kallas återigen huvudmodulen för ett nytt styrkommando. Tack vare hastigheten hos I\textsuperscript{2}C-bussen och fördröjningen hos PWM-styrningen agerar roboten på nästa kommando utan ett ryck emellan. 

Styrkommandot \textit{Rotera 90\textdegree\ vänster/höger} innebär en vinkelrät rotation åt respektive håll. Här förutsätts roboten befinna sig mitt i en modul och behöver med andra ord inte reglera sig i vertikal- eller horisontellt led. Regleringen av rotation sker med hjälp av det gyro som förmedlar vinkelhastighet till sensormodulen. När en rotation påbörjas summeras vinkelhastigheterna hos styrmodulen i takt med varenda nytt sensordata. Nivån som summationen sker till byter endast tecken mellan vänster- och högerrotation. Det är rotationsregleringen som sätter kravet att sensordata ska skickas med $30$ Hz för att minimera felet vid snabba rotationer. 

Styrkommandot \textit{Rotera 180\textdegree} innebär ett halvt varvs rotation av roboten. Regleringen sker precis på samma sätt som den vinkelräta rotationen ovan. Den enda skillnaden är det tak summationen sker till. 


För att hantera det sensorfel som gyrot för med sig följer ytterligare en reglering efter båda typerna av rotation. Regleringen bygger på att det finns en vägg att förhålla sig till och kallas därför inte om roboten befinner sig i en fyrvägskorsning. När det finns en vägg åt något håll rätar roboten upp sig genom att minimera differensen mellan den främre och bakre sensorn. 

Stykommandot \textit{Stopp} innebär att båda hjulparen stannas och ingen reglering sker. 

\item[Manuellt läge] I manuellt läge styrs roboten via styrkommandon från datormodulen. Dess styrkommandon skickas till huvudmodulen, därefter vidarebefordras de till styrmodulen via I\textsuperscript{2}C-bussen. När styrmodulen tar emot ett styrkommando och befinner sig i manuellt läge sker körningen helt utan reglering. 

  Styrmodulen fortsätter med samma styrkommando tills nästa har skickats. Med andra ord krävs det ett stoppkommando för att stanna roboten. Stoppkommandot skickas per automatik när datormodulens piltangent har släppts upp och behöver inte därför inte tas hänsyn till av användaren. 

  När ett styrkommando skickas till styrmodulen i manuellt läge tolkas även den tredje byten i sändningen som den önskade hastigheten. Hastigheten tas emot som ett heltal i intervallet noll till 100. Det skalas därefter till motsvarande intervall för pulsbreddsmoduleringen.

  \end{description}

\subsection{Datormodulen}

<<<<<<< HEAD
\begin{figure}[H]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/software}}
	\caption{Skiss över programvarans grafiska användargränssnitt\label{software}}	
\end{figure}

=======
\pagebreak

\section{Intermodulär kommunikation}
I denna del förklaras hur kommunikationen mellan robotens olika moduler fungerar.

\subsection{Informationsflöde}
Eftersom flera olika typer av data skickas mellan de olika modulerna inleds kommunikationen med ett ID som betecknar vilken typ av data som skickas. Dessa ID:n har värden mellan 251-255, för att kunna skiljas från alla andra värden som skickas. Andra värden än kommunikations-ID får alltså \emph{inte} anta värden större än 250. Denna uppdelning har gjorts för att underlätta felhantering.

\begin{longtable}[l]{| l | l |} \hline
\textbf{ID} & \textbf{Datatyp} \\ \hline 
255 & Styrkommando \\ \hline
254 & Kartinformation \\ \hline
253 & Sensordata \\ \hline
252 & Styrinställning \\ \hline

\caption{Tabell över kommunikations-ID}\label{kommunikationstab}
\end{longtable}

I figur \ref{informationFlow} visualiseras informationsflödet. Där anges mottagare och sändare samt vilken typ av information som går mellan dem.

\begin{figure}[htbp]
\centering
\noindent\resizebox{1\linewidth}{!}{
	\input{images/informationFlow}}
	\caption{Schema över informationsflödet\label{informationFlow}}	
\end{figure}

\subsubsection{Kommunikationsprotokoll - styrkommandon}
Protokollet som används för att skicka styrkommandon både datormodul $\rightarrow$ huvudmodul och huvudmodul $\rightarrow$ styrmodul finns illustrerat i figur \ref{styrdata}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/controlldata}}
	\caption{Protokoll för överföring av styrkommandon\label{styrdata}}	
\end{figure}

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (1 byte) - Kommunikations-ID, se tabell \ref{kommunikationstab}.
	\item B (1 byte) - Definierar vilket kommando som skickas, se tabell \ref{styrtab}.
	\item C (1 byte) - Hastighet om manuellt läge, valfritt i autonomnt då det inte tas hänsyn till (tillåtna värden: 0-245).
\end{itemize}

\subsubsection{Kommunikationsprotokoll - kartinformation}
Huvudmodulen kommer för varje ny kartmodul skicka data till datormodulen som ritar upp den nya informationen grafiskt. Varje kartmodul representeras av en position i en tvådimensionell array. För överföring av denna information används följande protokoll:

 \begin{figure}[H]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/mapdata}}
	\caption{Protokoll för överföring av kartdata \label{kartdata}}	
\end{figure} 

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (1 byte) - Kommunikations-ID, se tabell \ref{kommunikationstab}.
	\item B (1 byte) - x-koordinat (tillåtna värden: 0-28).
	\item C (1 byte) - y-koordinat (tillåtna värden: 0-28).
	\item D (1 byte) - Information om vad som finns i noden, se tabell \ref{maptab}.
\end{itemize}

\subsubsection{Kommunikationsprotokoll - sensordata}
Sensordata skickas enligt protokollet i figur \ref{sensordata}.

 \begin{figure}[H]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/sensordata}}
	\caption{Protokoll för överföring av sensordata\label{sensordata}}	
\end{figure} 

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A - Kommunikations-ID, se tabell \ref{kommunikationstab}.
	\item B - Sensordatapaket
	\begin{itemize}
	\item ID (1 byte) - identifierar sensorn, se tabell \ref{sensortab}.
	\item Data (1 byte) - sensorns värde (tillåtna värden: 0-245).
	\end{itemize}
\end{itemize}

\subsubsection{Kommunikationsprotokoll - styrinställningar}
Protokollet som används för att skicka styrinställningar både datormodul $\rightarrow$ huvudmodul och huvudmodul $\rightarrow$ styrmodul finns illustrerat i figur \ref{styrkomm}.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/controlldata}}
	\caption{Protokoll för överföring av styrkommandon\label{styrkomm}}	
\end{figure}

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (1 byte) - Kommunikations-ID, se tabell \ref{kommunikationstab}.
	\item B (1 byte) - Definierar vilken styrinställning som skickas, se tabell \ref{styrinsttab}.
	\item C (4 byte) - 0/1 om av/på, annars flyttal (C float).
\end{itemize}

\subsection{Tabeller}

\begin{longtable}[l]{| l | l |} \hline
\textbf{ID} & \textbf{Kartinformation} \\ \hline 
244 & Vägg \\ \hline
243 & Mål \\ \hline
242 & Start \\ \hline
[0,225] & Där roboten åkt \\ \hline

\caption{Tabell över kartvärden }\label{maptab}
\end{longtable}

\begin{longtable}[l]{| l | l | c |} \hline
\textbf{ID} & \textbf{Sensor} & \textbf{Enhet} \\ \hline 
1 & IR-sensor höger-fram & cm \\ \hline
2 & IR-sensor vänster-fram  & cm \\ \hline
3 & IR-sensor höger-bak  & cm  \\ \hline
4 & IR-sensor vänster-bak  &  cm \\ \hline
5 & Lasersensor (high) & cm  \\ \hline
6 & Lasersensor (low) & cm  \\ \hline
7 & Rotation kring z-axeln & rad/s \\ \hline
8 & IR-sensor för mål & 0/1 \\ \hline
\caption{Tabell över sensorerna}\label{sensortab}
\end{longtable}

\begin{longtable}[l]{| l | l |} \hline
\textbf{ID} & \textbf{Styrkommando} \\ \hline 
1 & Kör fram \\ \hline
2 & Kör bak \\ \hline
3 & Rotera åt höger \\ \hline
4 & Rotera åt vänster \\ \hline
5 & Fram och höger \\ \hline
6 & Fram och vänster \\ \hline
7 & Bak och höger \\ \hline
8 & Bak och vänster \\ \hline
9 & Gripklo öppna/stäng \\ \hline

\caption{Tabell över styrkommandon}\label{styrtab}
\end{longtable}

\begin{longtable}[l]{| l | l |} \hline
\textbf{ID} & \textbf{Styrinställning} \\ \hline 
1 & Reglering av/på \\ \hline
2 & P-värde \\ \hline
3 & D-värde \\ \hline
4 & K-värde \\ \hline

\caption{Tabell över styrinställningar}\label{styrinsttab}
\end{longtable}


\begin{table}[h]
\begin{tabular}{|l|l|l|l|l|} \hline

\textbf{Kommando} & \textbf{Id} & \textbf{Info} & \textbf{Kommentar}\\ \hline

252 & 1 & 1/0 & 1 om reglering är på, 0 annars \\ \hline
252 & 2 & Data & Regleringfunktionens P-värde \\ \hline
252 & 3 & Data & Regleringfunktionens D-värde \\ \hline
252 & 4 & 1/0 & 1 om gripklo ska vara öppen, 0 om den ska vara stängd \\ \hline


253 & 1 & 1 & Data för främre högra IR-sensorn kommer skickas härnäst \\ \hline
253 & 2 & Data & Värde på den främre högra IR-sensorn \\ \hline
253 & 3 & 2 & Data för främre vänstra IR-sensorn kommer skickas härnäst \\ \hline
253 & 4 & Data & Värde på den främre vänstra IR-sensorn \\ \hline
253 & 5 & 3 & Data för bakre högra IR-sensorn kommer skickas härnäst \\ \hline
253 & 6 & Data & Värde på den bakre högra IR-sensorn \\ \hline
253 & 7 & 4 & Data för bakre vänstra IR-sensorn kommer skickas härnäst \\ \hline
253 & 8 & Data & Värde på den bakre vänstra IR-sensorn \\ \hline

253 & 9 & 5 & LIDAR-Lite's 8 mest signifikanta bitar kommer skickas härnäst \\ \hline
253 & 10 & Data & Värde på LIDAR-Lite's 8 mest signifikanta bitar \\ \hline
253 & 11 & 6 & LIDAR-Lite's 8 minst signifikanta bitar kommer skickas härnäst \\ \hline
253 & 12 & Data & Värde på LIDAR-Lite's 8 minst signifikanta bitar \\ \hline

253 & 13 & 7 & Data för gyrot kommer skickas härnäst \\ \hline
253 & 14 & Data & Värde på gyrot \\ \hline

253 & 15 & 8 & Data för IR-detektorn kommer skickas härnäst \\ \hline
253 & 16 & 1/0 & 1 skickas om målet är upptäckt, 0 annars \\ \hline

255 & - & - & Kommando att köra framåt \\ \hline
255 & - & Data/not care\text{*} & Hur fort roboten ska köras framåt \\ \hline
255 & - & - & Kommando att köra bakåt \\ \hline
255 & - & Data/not care & Hur fort roboten ska köras bekåt \\ \hline
255 & - & - & Kommando att rotera höger \\ \hline
255 & - & Data/not care & Hur fort roboten ska rotera åt höger  \\ \hline
255 & - & - & Kommando att rotera vänster \\ \hline
255 & - & Data/not care & Hur fort roboten ska rotera åt vänster  \\ \hline

\end{tabular}
\end{table}

\text{*} Reagerar på data vid manuellt läge och ignorerar data vid autonomt

\section{Slutsatser}
\textit{Vilka förbättringar skulle kunna göras?}

\pagebreak
\addcontentsline{toc}{section}{Referenser}
\bibliographystyle{ieeetr}
\bibliography{references}

\pagebreak


\appendix

\end{flushleft}

\end{document}

