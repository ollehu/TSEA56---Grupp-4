\documentclass[11pt]{article}

\usepackage{extras} % Se extras.sty

\begin{document}
\begin{titlepage}
\begin{center}

{\Large\bfseries TSEA56 - Kandidatprojekt i elektronik \\ LIPS Teknisk dokumentation}

\vspace{5em}

Version 1.0

\vspace{5em}
Grupp 4 \\
\begin{tabular}{rl}
Hynén Ulfsjöö, Olle&\verb+ollul666+
\\
Wasteson, Emil&\verb+emiwa068+
\\
Tronje, Elena&\verb+eletr654+
\\
Gustafsson, Lovisa&\verb+lovgu777+
\\
Inge, Zimon&\verb+zimin415+
\\
Strömberg, Isak&\verb+isast763+
\\
\end{tabular}

\vspace{5em}
\today

\vspace{16em}
Status
\begin{longtable}{|l|l|l|} \hline

Granskad & - & - \\ \hline
Godkänd & - & - \\ \hline
 
\end{longtable}

\end{center}
\end{titlepage}

\pagebreak
\begin{center}

\section*{PROJEKTIDENTITET}
2016/VT, Undsättningsrobot Gr. 4

Linköpings tekniska högskola, ISY
\vspace{5em}
%\begin{center}

\begin{tabular}{|l|l|l|l|} \hline
\textbf{Namn} & \textbf{Ansvar} & \textbf{Telefon} & \textbf{E-post}  \\ \hline 
Isak Strömberg (IS) & Projektledare & 073-980 38 50 & isast763@student.liu.se \\ \hline
Olle Hynén Ulfsjöö (OHU)& Dokumentansvarig & 070-072 91 84 & ollul666@student.liu.se \\ \hline
Emil Wasteson (EW) & Hårdvaruansvarig & 076-836 61 66 & emiwa068@student.liu.se \\ \hline
Elena Tronje (ET) & Mjukvaruansvarig & 072-276 92 93 & eletr654@student.liu.se \\ \hline
Zimon Inge (ZI)& Testansvarig & 070-171 35 18 & zimin415@student.liu.se \\ \hline
Lovisa Gustafsson (LG) & Leveransansvarig & 070-210 32 53 & lovgu777@student.liu.se \\ \hline
\end{tabular}

%\end{center}

E-postlista för hela gruppen: isast763@student.liu.se

\vspace{5em}
Kund: ISY, Linköpings universitet 
tel: 013-28 10 00, fax: 013-13 92 82 \\
Kontaktperson hos kund: Mattias Krysander \\
tel: 013-28 21 98, e-post: matkr@isy.liu.se \\

\vspace{5em}
Kursansvarig:  Tomas Svensson\\
tel: 013-28 13 68, e-post: tomass@isy.liu.se \\
Handledare: Peter Johansson \\
tel: 013-28 13 45, e-post: peter.a.johansson@liu.se
\end{center}
\pagebreak

\tableofcontents

\pagebreak

\section*{Dokumenthistorik}
\begin{table}[h]
\begin{tabular}{|l|l|l|l|l|} \hline

\textbf{Version} & \textbf{Datum} & \textbf{Utförda förändringar} & \textbf{Utförda av} & \textbf{Granskad} \\ \hline
1.0 & - &  Första utkastet & Grupp 4 & - \\ \hline
\end{tabular}
\end{table}

\pagebreak
\pagenumbering{arabic}

\begin{flushleft}
\section{Inledning}
\textit{Bakgrund och syfte}

Projektets syfte är att konstruera en undsättningsrobot med kartläggning. Detta dokument syftar till att ge en detaljerad teknisk beskrivning av projektet på en nivå där resultatet ska kunna återskapas. Innehållet består av detaljerade beskrivningar av systemets olika delar, dess mjuk- och hårdvarukomponenter samt implementationen av dessa.

\section{Produkten}
\textit{En bild på produkten och en beskrivning av hur den fungerar. Beskriv vad den används till.}

Produkten som konstruerats är en undsättningsrobot. Den består av ett chassi med fyra hjul, ett batteri, en av/på-brytare samt en gripklo. På chassit är huvudmodulen, sensormodulen och styrmodulen ihopkopplade via en I\textsuperscript{2}C-buss för kommunikation dem emellan. Roboten kommunicerar med datormodulen via Bluetooth\textsuperscript{\circledR}. En övergripande bild av produkten återfinns i figur \ref{overview}. Gripklon kontrolleras av styrmodulen och sensormodulen tar in data från sensorerna. För att fästa sensorerna på chassit används 3D-printade fästen.

Varje modul har en processor samt annan nödvändig hårdvara, som lågpassfilter och brytare, kopplade på ett virkort. Virkorten kan användas som grund för att tillverka kretskort med motsvarande funktion. 

Robotens uppgift är att söka av en labyrint bestående av 40 cm breda korridorer med hjälp av en avsökningsalgoritm och identifiera en nödställd som sänder ut IR-ljus. När målet är identifierat ska kortaste vägen mellan labyrintens ingång och målet bestämmas. Efter det ska roboten hämta en förnödenhet vid starten, köra kortaste vägen till den nödställda och lämna av förnödenheten för att sedan ta sig tillbaka samma väg till starten. Roboten kartlägger labyrinten internt under tiden den utforskar den och lagrar informationen för att kunna skicka den till datormodulen för uppritning. 


\begin{figure}[!htbp]
\centering
\noindent\resizebox{\linewidth}{!}{
	\input{images/overview}}
	\caption{Det totala systemet \label{overview}}	
\end{figure}

\pagebreak


\section{Teori}
Nedan följer en sammanfattning av den teori som robotens reglering och optimering bygger på.

\subsection{Optimering}


\subsection{Reglering}
\label{subsection:reglering}
\section{Systemet}
\textit{Ett översiktligt blockschema och en beskrivning av hela systemet.}

Roboten i sin miljö finns illustrerad i figur \ref{system}. Den kan både köras manuellt och autonomt, något som bestäms av en brytare på roboten. Kommunikationen med datormodulen är dubbelriktad via Bluetooth\textsuperscript{\circledR}. Roboten ska klara sitt uppdrag utan kommunikation med datormodulen, det vill säga att kartläggning, styrning och optimering av kortaste väg sker lokalt hos roboten. Banan är uppbyggd enligt banspecifikationen och uppdraget utförs enligt tävlingsreglerna, se appendix [??].

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/bana}}
	\caption{Översikt av banan\label{system}}	
\end{figure}

\subsection{Beskrivning av systemet}
Roboten navigerar med hjälp värden som fås av sensormodulens sensorer. En lasersensor, fäst på ett servo, mäter avstånd framåt, fyra IR-sensorer mäter robotens avstånd till sidoväggarna, ett gyroskop mäter robotens vinkelhastighet och en IR-detektor identifierar den nödställde. Med jämnna intervall kommunicerar sensormodulen dessa värden till huvudmodulen, som i sin tur vidarebefordrar de till styrmodulen. 

I styrmodulen är en regleringsmodell implementerad, vilken säkerställer att roboten färdas i mitten av korridorerna samt kan rotera både 90 och 180 grader utan att stöta mot väggar. Önskade värden kan skrivas ut på en LCD-display, vilken också är en del av styrmodulen.

Under färden sker autonomt kartläggning och beräkning av kortaste väg mellan ingången och den nödställde. När roboten är uppkopplad mot datormodulen ritar mjukvaran på datorn successivt upp en karta och presenterar utvalda mätvärden i realtid. 

När den kortaste vägen är funnen använder roboten denna rutt för att förse den nödställde med en förnödenhet. Förnödenheten transporteras med hjälp av robotens gripklo, som kontrolleras av styrmodulen.

På systemnivå är det om målet är funnet och om kortaste väg kan garanterats som avgör robotens beslut, vilket figur \ref{blockSystem} illustrerar.

\begin{figure}[htbp]
\centering
\noindent\resizebox{1\linewidth}{!}{
	\input{images/systemet}}
	\caption{Övergripande blockschema för systemet}	\label{blockSystem}
\end{figure}

\section{Begränsningar} 
Roboten är begränsad till att navigera i korridorer som är ca 40 cm breda och klarar enbart av korsningar med 90 gradersvinklar.

\section{Modulerna}
\textit{Innehåller mera detaljerade blockschemor och beskrivningar av varje modul. Tänk på läsbarheten och växla mellan figurer och text.}
I detta avsnitt följer en detaljerad beskrivning av systemets ingående moduler. 

\subsection{Huvudmodulen}
Huvudmodulen har som uppgift att ta emot och förmedla information mellan de andra modulera, hantera den interna kartläggnigen samt att ta alla övergripande beslut. Bluetooth\textsuperscript{\circledR} används för att kommunicera med datormodulen och en avbrottsstyrd I\textsuperscript{2}C-buss används för att kommunicera med sensor- och styrmodulen, vilket visas i figur \ref{communication}. När det kommer till prioriteringen av sensor- och styrmodul har styrmodulen kopplats till en extern avbrottsingång med högre prioritet än sensormodulen.

\begin{figure}[htbp]
\noindent\resizebox{.97\textwidth}{!}{
	\input{images/communication}}
	\caption{Intermodulär kommunikation \label{communication}}
\end{figure}

Det finns två olika körlägen för roboten, ett autonomt och ett manuellt läge. När det autonoma läget är aktiverat tas beslut utifrån en avsökningsalgoritm som i grunden sker genom högerföljning och där beslutet om vilken kartmodul som ska besökas härnäst baseras på datan som skickats från sensormodulen. När beslutet är taget skickas motsvarande kommando till styrmodulen, som sedan utför önskad operation. Nytt beslut tas när styrmodulen anser sig vara färdig med nuvarande kommando och begär ett nytt genom avbrott. Hela kommunikationsflödet i autonomt läge finns beskrivet i figur \ref{autonomousMode}. I manuellt läge skickas styrkommandon från datormodulen, via Bluetooth\textsuperscript{\circledR}, till huvudmodulen som sen vidarebefodrar dessa till styrmodulen. Den informationen som skickas är begränsad till när en knapp trycks ned och när en knapp släpps, och i så fall vilken. Flödet finns beskrivet i figur \ref{manualMode}. Rent hårdvarumässigt styrs detta med hjälp av en switch kopplad till huvudmodulen.

Beräkningen av kortaste vägen till målet sker med utgångspunkt från Dijkstras algoritm. När målet är funnet numreras varje nod med en siffra som representerar ett avstånd till målet. Kortaste väg från start till mål fås då genom att, för varje nod välja den närliggande nod med lägst siffra. För att inte utforska mer än nödvändigt används en pessimistisk skattning av avståndet som motsvarar hur många steg från start som målet är om roboten följt vägen och undvikt återvändsgränder. Detta avstånd jämförs sedan med summan av hur köravståndet från målet till aktuell nod samt manhattanavståndet från start till aktuell nod. Är det uträknade avståndet lika eller större än skattningen är det inte nödvändigt att utforska mer åt det hållet.

\begin{figure}[htbp]
\centering
\noindent\resizebox{0.9\linewidth}{!}{
	\input{images/autonomousMode}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid autonom styrning \label{autonomousMode}}	
\end{figure}

\begin{figure}[htbp]
\centering
\noindent\resizebox{0.9\linewidth}{!}{
	\input{images/manualMode}}
	\cprotect\caption{Flödesschema som beskriver förloppet vid manuell styrning \label{manualMode}}	
\end{figure}

\pagebreak

\subsection{Sensormodulen}
Robotens sensormodul har som uppgift att läsa av sensorerna och kommunicera datan till huvudmodulen. De sensorer som används är följande, NAMN PÅ SENSORER
\begin{description}
	\item[Avstånd] \hfill \\
	4 x IR-sensor \verb+GP2D120+ (4 cm till 30 cm) \\
	1 x Laser-sensor \verb+LIDAR-Lite v2+ (0 till 40 m) \\
	\item[Vinkelhastighet] \hfill \\
	1 x Gyro/accelerometer \verb+MPU-6500+ 
	\item[Identifierare av nödställd] \hfill \\
	1 x IR-detektor \verb+IRM-8601-S+
\end{description}
och är placerade enligt figur \ref{sensors}. 

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\textwidth}{!}{
	\input{images/sensor}	}
	\caption{Sensorplacering \label{sensors}}
\end{figure}

\subsection{Styrmodulen}
Styrmodulen är den del av roboten som tar emot och verkställer styrkommandon och ser till att roboten tar sig fram på önskat sätt. Det som ska hanteras är styrning av chassits motorer för att få roboten att röra på sig och att styra gripklon. Styrmodulen kan agera i två lägen, autonomt eller manuellt läge.

\subsubsection*{Autonomt läge}
I autonomt läge agerar styrmodulen på beslut som tas från huvudmodulen. Målet är att navigera modulvis genom den avsökningalgoritm som huvudmodulen utövar. Styrmodulen begär ett nytt styrkommando genom att skicka en uppåtflank på en utgång som är kopplad till ett avbrott hos huvudmodulen. Huvudmodulen tar därefter ett beslut om vilket styrkommando som ska skickas. De möjliga styrkommandona är \textit{Fram}, \textit{Rotera vänster}, \textit{Rotera höger}, \textit{Rotera 180\textdegree} och \textit{Stopp}. 

När ett styrkommando tas emot av styrmodulen sker regleringen i samband med inkommande sensordata. För att regleringen ska agera snabbt nog behöver sensordata skickas i takten $30$ Hz. När sensordata tas emot sparas samtliga värden lokalt i styrmodulen, därefter kallas den metod som sköter reglering av styrkommandot. 

Styrkommandot \textit{Fram} innebär att roboten ska flytta sig en modul föröver. Modullängden är detsamma för hela banan och satt till $40$ cm. Roboten beräknar tillryggalagd sträcka genom att beräkna antalet varv hjulen roterar och under färden sker reglering enligt avsnitt \ref{subsection:reglering}. När modulen är avverkad kallas återigen huvudmodulen för ett nytt styrkommando. Tack vare hastigheten hos I\textsuperscript{2}C-bussen och fördröjningen hos PWM-styrningen agerar roboten på nästa kommando utan ett ryck emellan. 

Styrkommandot \textit{Rotera vänster/höger} innebär en vinkelrät rotation åt respektive håll. Här förutsätts roboten befinna sig mitt i en modul och behöver med andra ord inte reglera sin position. Regleringen av rotation sker med hjälp av det gyro som förmedlar vinkelhastighet till sensormodulen. När en rotation påbörjas summeras vinkelhastigheterna hos styrmodulen i takt med varenda nytt sensordata. Nivån som summationen sker till byter endast tecken mellan vänster- och högerrotation. Det är rotationsregleringen som sätter kravet att sensordata ska skickas med $30$ Hz för att minimera felet vid snabba rotationer. 

Styrkommandot \textit{Rotera 180\textdegree} innebär ett halvt varvs rotation av roboten. Regleringen sker precis på samma sätt som den vinkelräta rotationen ovan. Den enda skillnaden är det tak summationen sker till. 


För att hantera det sensorfel som gyrot för med sig följer ytterligare en reglering efter båda typerna av rotation. Regleringen bygger på att det finns en vägg att förhålla sig till och kallas därför inte om roboten befinner sig i en fyrvägskorsning. När det finns en vägg åt något håll rätar roboten upp sig genom att minimera differensen mellan den främre och bakre sensorn. 

Stykommandot \textit{Stopp} innebär att båda hjulparen stannas och ingen reglering sker. 

\subsubsection*{Manuellt läge}



\subsection{Datormodulen}

\section{Intermodulär kommunikation}
I denna del förklaras hur kommunikationen mellan robotens olika moduler fungerar.

\subsection{Informationsflöde}
Eftersom flera olika typer av data skickas mellan de olika modulerna inleds kommunikationen med ett ID som betecknar vilken typ av data som skickas. Dessa ID:n har värden mellan 251-255, för att kunna skiljas från alla andra värden som skickas. Andra värden än kommunikations-ID får alltså \emph{inte} anta värden större än 250. 

I figur \ref{informationFlow} visualiseras informationsflödet. Där anges mottagare och sändare samt vilken typ av information som går mellan dem.

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/informationFlow}}
	\caption{Schema över informationsflödet\label{informationFlow}}	
\end{figure}

\subsubsection{Kommunikationsprotokoll - styrkommandon}
Följande protokoll används för att skicka styrkommandon (gäller både för datormodul $\rightarrow$ huvudmodul och huvudmodul $\rightarrow$ styrmodul):

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/controlldata}}
	\caption{Protokoll för överföring av styrkommandon\label{styrdata}}	
\end{figure}

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (1 byte) - Kommunikations-ID, se tabell \ref{kommunikationstab}.
	\item B (1 byte) - Definierar vilket kommando som skickas, se tabell \ref{styrtab}.
	\item C (1 byte) - Hastighet (om manuellt läge), sträcka/vinkel (om autonomt läge)(tillåtna värden: 0-245).
\end{itemize}

\subsubsection{Kommunikationsprotokoll - kartinformation}
Huvudmodulen kommer för varje ny kartmodul skicka data till datormodulen som ritar upp den nya informationen grafiskt. 

Varje korsning kommer att representeras som en nod och vägarna däremellan som bågar. För att så enkelt som möjligt överföra denna information från huvudmodulen till datormodulen kommer varje nod att representeras enligt protokollet nedan:

 \begin{figure}[H]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/mapdata}}
	\caption{Protokoll för överföring av kartdata \label{kartdata}}	
\end{figure} 

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (1 byte) - Kommunikations-ID.
	\item B (1 byte) - Motsvarar nodens x-koordinat (tillåtna värden: 0-15).
	\item C (1 byte) - Motsvarar nodens y-koordinat (tillåtna värden: 0-15).
	\item D (1 byte) - Representerar väggar kring noden (11 = vägg, 00 = ingen vägg) i nordlig, västlig, sydlig och östlig riktning (b0-1 = N, b2-3 = W, b4-5 = S, b6-7 = E).
\end{itemize}

\subsubsection{Kommunikationsprotokoll - sensordata}
Sensordata skickas enligt följande protokoll:

 \begin{figure}[H]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/sensordata}}
	\caption{Protokoll för överföring av sensordata\label{sensordata}}	
\end{figure} 

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A - Kommunikations-ID
	\item B - Sensordatapaket
	\begin{itemize}
	\item ID (1 byte) - identifierar sensorn, se tabell \ref{sensortab}.
	\item Data (1 byte) - sensorns värde (tillåtna värden: 0-245).
	\end{itemize}
\end{itemize}

\subsubsection{Kommunikationsprotokoll - styrinställningar}
Följande protokoll används för att skicka styrinställningar (gäller både för datormodul $\rightarrow$ huvudmodul och huvudmodul $\rightarrow$ styrmodul):

\begin{figure}[htbp]
\centering
\noindent\resizebox{.8\linewidth}{!}{
	\input{images/controlldata}}
	\caption{Protokoll för överföring av styrkommandon\label{styrdata}}	
\end{figure}

Respektive segment motsvarar följande: 
\begin{itemize}
	\item A (1 byte) - Kommunikations-ID, se tabell \ref{kommunikationstab}.
	\item B (1 byte) - Definierar vilken styrinställning som skickas, se tabell \ref{styrinsttab}.
	\item C (4 byte) - 0/1 om av/på. Annars flyttal (C float).
\end{itemize}

\subsection{Tabeller}

\begin{longtable}[l]{| l | l | c |} \hline
\textbf{ID} & \textbf{Sensor} & \textbf{Enhet} \\ \hline 
1 & IR-sensor höger-fram & cm \\ \hline
2 & IR-sensor vänster-fram  & cm \\ \hline
3 & IR-sensor höger-bak  & cm  \\ \hline
4 & IR-sensor vänster-bak  &  cm \\ \hline
5 & Lasersensor & cm  \\ \hline
6 & Rotation kring z-axeln & rad/s \\ \hline
7 & IR-sensor för mål & cm \\ \hline
\caption{Tabell över sensorerna}\label{sensortab}
\end{longtable}

\begin{longtable}[l]{| l | l |} \hline
\textbf{ID} & \textbf{Styrkommando} \\ \hline 
1 & Kör fram \\ \hline
2 & Kör bak \\ \hline
3 & Rotera åt höger \\ \hline
4 & Rotera åt vänster \\ \hline
5 & Fram och höger \\ \hline
6 & Fram och vänster \\ \hline
7 & Bak och höger \\ \hline
8 & Bak och vänster \\ \hline
9 & Gripklo öppna/stäng \\ \hline

\caption{Tabell över styrkommandon}\label{styrtab}
\end{longtable}

\begin{longtable}[l]{| l | l |} \hline
\textbf{ID} & \textbf{Styrinställning} \\ \hline 
1 & Reglering av/på \\ \hline
2 & P-värde \\ \hline
3 & D-värde \\ \hline
4 & K-värde \\ \hline

\caption{Tabell över styrinställningar}\label{styrinsttab}
\end{longtable}

\section{Slutsatser}
\textit{Vilka förbättringar skulle kunna göras?}

\pagebreak
\addcontentsline{toc}{section}{Referenser}
\bibliographystyle{ieeetr}
\bibliography{references}

\pagebreak


\appendix

\end{flushleft}

\end{document}
